primary_action_color: '#FFBC7D',
Â  Â  Â  Â  secondary_action_color: '#A8E6CF'
Â  Â  Â  },
Â  Â  Â  sky: {
Â  Â  Â  Â  background_color: '#B4D7FF',
Â  Â  Â  Â  primary_action_color: '#8FC1FF',
Â  Â  Â  Â  secondary_action_color: '#FFB6C1'
Â  Â  Â  },
Â  Â  Â  lemon: {
Â  Â  Â  Â  background_color: '#FFF9A3',
Â  Â  Â  Â  primary_action_color: '#FFE97D',
Â  Â  Â  Â  secondary_action_color: '#FFB6C1'
Â  Â  Â  }
Â  Â  };

Â  Â  // Initial Data Structure
Â  Â  let orders = [];
Â  Â  let currentEditingId = null;
Â  Â  let currentDate = new Date();
Â  Â  currentDate.setHours(0, 0, 0, 0); // Normalize to start of day

Â  Â  // --- Utility Functions ---

Â  Â  // Function to generate a unique ID
Â  Â  function generateId() {
Â  Â  Â  return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
Â  Â  }

Â  Â  // Function to show a toast notification
Â  Â  function showToast(message, type = 'success') {
Â  Â  Â  const toast = document.getElementById('toast');
Â  Â  Â  toast.textContent = message;
Â  Â  Â  toast.className = `toast active ${type}`;
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  toast.classList.remove('active');
Â  Â  Â  }, 3000);
Â  Â  }

Â  Â  // Function to apply the selected theme
Â  Â  function changeTheme(themeName) {
Â  Â  Â  const theme = themes[themeName];
Â  Â  Â  if (!theme) return;

Â  Â  Â  // Update active theme card
Â  Â  Â  document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('active'));
Â  Â  Â  document.querySelector(`.theme-card[data-theme="${themeName}"]`).classList.add('active');

Â  Â  Â  // Update CSS variables for all theme-dependent elements
Â  Â  Â  const style = document.documentElement.style;
Â  Â  Â  style.setProperty('--theme-bg-color', theme.background_color);
Â  Â  Â  style.setProperty('--primary-action-color', theme.primary_action_color);
Â  Â  Â  style.setProperty('--secondary-action-color', theme.secondary_action_color);

Â  Â  Â  // Update dynamic background/border colors (less ideal, but works without complex CSS)
Â  Â  Â  document.querySelector('.dashboard-container').style.background = `linear-gradient(135deg, ${theme.background_color} 0%, #B4D7FF 100%)`;
Â  Â  Â  document.querySelector('.btn-primary').style.background = `linear-gradient(135deg, ${theme.background_color} 0%, ${theme.primary_action_color} 100%)`;
Â  Â  Â  document.querySelector('.btn-primary').style.boxShadow = `0 4px 15px rgba(${hexToRgb(theme.background_color)}, 0.4)`;

Â  Â  Â  // Update table header background (requires manual class update or new style tag for production)
Â  Â  Â  const tableHead = document.querySelector('.data-table thead');
Â  Â  Â  tableHead.style.background = `linear-gradient(135deg, ${theme.background_color} 0%, ${theme.primary_action_color} 100%)`;
Â  Â  Â  
Â  Â  Â  // Update calendar button background
Â  Â  Â  document.querySelectorAll('.calendar-nav-btn').forEach(btn => {
Â  Â  Â  Â  btn.style.background = `linear-gradient(135deg, ${theme.background_color} 0%, ${theme.primary_action_color} 100%)`;
Â  Â  Â  Â  btn.style.boxShadow = `0 4px 12px rgba(${hexToRgb(theme.background_color)}, 0.4)`;
Â  Â  Â  });

Â  Â  Â  // Re-render calendar and table to pick up theme changes (e.g., today/has-orders colors)
Â  Â  Â  renderCalendar();
Â  Â  Â  renderTable();
Â  Â  }

Â  Â  // Helper function to convert hex to RGB for boxShadow
Â  Â  function hexToRgb(hex) {
Â  Â  Â  const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
Â  Â  Â  hex = hex.replace(shorthandRegex, function(m, r, g, b) {
Â  Â  Â  Â  return r + r + g + g + b + b;
Â  Â  Â  });
Â  Â  Â  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
Â  Â  Â  return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0, 0, 0';
Â  Â  }

Â  Â  // Function to round the Target DN value based on the specified rules
Â  Â  function roundTargetDN(value) {
Â  Â  Â  const num = parseInt(value);
Â  Â  Â  if (isNaN(num)) return 0;
Â  Â  Â  
Â  Â  Â  if (num % 5 === 0) {
Â  Â  Â  Â  return num;
Â  Â  Â  } else if ((num - 1) % 5 === 0) {
Â  Â  Â  Â  return num - 1; // e.g., 21 -> 20, 51 -> 50
Â  Â  Â  } else if ((num + 2) % 5 === 0) {
Â  Â  Â  Â  return num + 2; // e.g., 23 -> 25, 53 -> 55
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Default rounding to nearest 5
Â  Â  Â  return Math.round(num / 5) * 5;
Â  Â  }

Â  Â  // Function to load data from SDK (Simulated)
Â  Â  async function loadData() {
Â  Â  Â  const loadingElement = document.getElementById('loading');
Â  Â  Â  loadingElement.classList.add('active');
Â  Â  Â  try {
Â  Â  Â  Â  // Simulate SDK data fetch
Â  Â  Â  Â  const rawData = await element_sdk.persistence.load();
Â  Â  Â  Â  orders = rawData.orders || [];
Â  Â  Â  Â  showToast('Data loaded successfully!', 'success');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error loading data:", error);
Â  Â  Â  Â  orders = [];
Â  Â  Â  Â  // Simulate initial data if empty or error
Â  Â  Â  Â  if (orders.length === 0) {
Â  Â  Â  Â  Â  orders = [
Â  Â  Â  Â  Â  Â  { id: generateId(), date: '2025-12-01', type: 'BU 17', customerName: 'PT. Makmur Sejahtera', destination: 'Jakarta', targetDN: 20 },
Â  Â  Â  Â  Â  Â  { id: generateId(), date: '2025-12-01', type: 'CMI', customerName: 'CV. Jaya Abadi', destination: 'Surabaya', targetDN: 55 },
Â  Â  Â  Â  Â  Â  { id: generateId(), date: '2025-12-05', type: 'BU 17', customerName: 'PT. Bahagia Sentosa', destination: 'Bandung', targetDN: 50 },
Â  Â  Â  Â  Â  Â  { id: generateId(), date: '2025-12-10', type: 'CMI', customerName: 'UD. Lancar Terus', destination: 'Semarang', targetDN: 25 },
Â  Â  Â  Â  Â  Â  { id: generateId(), date: new Date().toISOString().split('T')[0], type: 'BU 17', customerName: 'PT. Kertas DN', destination: 'Yogyakarta', targetDN: 50 }
Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  // Attempt to save the sample data
Â  Â  Â  Â  Â  await saveData();
Â  Â  Â  Â  Â  showToast('Loaded sample data.', 'success');
Â  Â  Â  Â  }
Â  Â  Â  } finally {
Â  Â  Â  Â  loadingElement.classList.remove('active');
Â  Â  Â  Â  renderAll();
Â  Â  Â  }
Â  Â  }

Â  Â  // Function to save data to SDK (Simulated)
Â  Â  async function saveData() {
Â  Â  Â  try {
Â  Â  Â  Â  await element_sdk.persistence.save({ orders });
Â  Â  Â  Â  // showToast('Data saved successfully!', 'success'); // Comment out for less spam
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error saving data:", error);
Â  Â  Â  Â  showToast('Error saving data!', 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // --- Rendering Functions ---

Â  Â  // Calculate statistics
Â  Â  function calculateStats(data) {
Â  Â  Â  let totalBU17 = 0;
Â  Â  Â  let totalCMI = 0;
Â  Â  Â  
Â  Â  Â  data.forEach(order => {
Â  Â  Â  Â  const target = parseFloat(order.targetDN) || 0;
Â  Â  Â  Â  if (order.type === 'BU 17') {
Â  Â  Â  Â  Â  totalBU17 += target;
Â  Â  Â  Â  } else if (order.type === 'CMI') {
Â  Â  Â  Â  Â  totalCMI += target;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  return {
Â  Â  Â  Â  totalBU17: totalBU17.toFixed(2),
Â  Â  Â  Â  totalCMI: totalCMI.toFixed(2),
Â  Â  Â  Â  totalAll: (totalBU17 + totalCMI).toFixed(2)
Â  Â  Â  };
Â  Â  }

Â  Â  // Render statistics cards
Â  Â  function renderStats(data) {
Â  Â  Â  const stats = calculateStats(data);
Â  Â  Â  document.getElementById('totalBU17').textContent = stats.totalBU17;
Â  Â  Â  document.getElementById('totalCMI').textContent = stats.totalCMI;
Â  Â  Â  document.getElementById('totalAll').textContent = stats.totalAll;
Â  Â  }

Â  Â  // Populate filter dropdowns
Â  Â  function populateFilters() {
Â  Â  Â  const filterMonth = document.getElementById('filterMonth');
Â  Â  Â  const filterDate = document.getElementById('filterDate');
Â  Â  Â  
Â  Â  Â  filterMonth.innerHTML = '<option value="">All Months</option>';
Â  Â  Â  filterDate.innerHTML = '<option value="">All Dates</option>';
Â  Â  Â  
Â  Â  Â  const months = new Set();
Â  Â  Â  const dates = new Set();

Â  Â  Â  orders.forEach(order => {
Â  Â  Â  Â  const date = new Date(order.date + 'T00:00:00'); // Ensure UTC neutrality for date parts
Â  Â  Â  Â  const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
Â  Â  Â  Â  const fullDate = order.date;
Â  Â  Â  Â  months.add(yearMonth);
Â  Â  Â  Â  dates.add(fullDate);
Â  Â  Â  });

Â  Â  Â  const sortedMonths = Array.from(months).sort().reverse();
Â  Â  Â  sortedMonths.forEach(ym => {
Â  Â  Â  Â  const [year, month] = ym.split('-');
Â  Â  Â  Â  const monthName = new Date(year, month - 1, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
Â  Â  Â  Â  filterMonth.innerHTML += `<option value="${ym}">${monthName}</option>`;
Â  Â  Â  });

Â  Â  Â  const sortedDates = Array.from(dates).sort().reverse();
Â  Â  Â  sortedDates.forEach(dateStr => {
Â  Â  Â  Â  filterDate.innerHTML += `<option value="${dateStr}">${dateStr}</option>`;
Â  Â  Â  });
Â  Â  }

Â  Â  // Filter data based on search and filters
Â  Â  function filterData() {
Â  Â  Â  const searchInput = document.getElementById('searchInput').value.toLowerCase();
Â  Â  Â  const filterMonth = document.getElementById('filterMonth').value;
Â  Â  Â  const filterDate = document.getElementById('filterDate').value;
Â  Â  Â  const filterType = document.getElementById('filterType').value;

Â  Â  Â  return orders.filter(order => {
Â  Â  Â  Â  const searchMatch = searchInput === '' ||
Â  Â  Â  Â  Â  order.customerName.toLowerCase().includes(searchInput) ||
Â  Â  Â  Â  Â  order.destination.toLowerCase().includes(searchInput) ||
Â  Â  Â  Â  Â  order.type.toLowerCase().includes(searchInput);

Â  Â  Â  Â  const date = new Date(order.date + 'T00:00:00');
Â  Â  Â  Â  const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
Â  Â  Â  Â  
Â  Â  Â  Â  const monthMatch = filterMonth === '' || yearMonth === filterMonth;
Â  Â  Â  Â  const dateMatch = filterDate === '' || order.date === filterDate;
Â  Â  Â  Â  const typeMatch = filterType === '' || order.type === filterType;

Â  Â  Â  Â  return searchMatch && monthMatch && dateMatch && typeMatch;
Â  Â  Â  });
Â  Â  }

Â  Â  // Render the main data table
Â  Â  function renderTable() {
Â  Â  Â  const tableBody = document.getElementById('tableBody');
Â  Â  Â  const emptyState = document.getElementById('emptyState');
Â  Â  Â  const filteredOrders = filterData();
Â  Â  Â  
Â  Â  Â  // Group by date
Â  Â  Â  const groupedOrders = filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date)).reduce((acc, order) => {
Â  Â  Â  Â  (acc[order.date] = acc[order.date] || []).push(order);
Â  Â  Â  Â  return acc;
Â  Â  Â  }, {});

Â  Â  Â  tableBody.innerHTML = '';

Â  Â  Â  if (filteredOrders.length === 0) {
Â  Â  Â  Â  emptyState.style.display = 'block';
Â  Â  Â  Â  renderStats(filteredOrders);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  emptyState.style.display = 'none';
Â  Â  Â  
Â  Â  Â  let grandTotal = 0;

Â  Â  Â  for (const date in groupedOrders) {
Â  Â  Â  Â  const ordersByDate = groupedOrders[date];
Â  Â  Â  Â  let dailyTotal = 0;
Â  Â  Â  Â  
Â  Â  Â  Â  // Date Group Header Row
Â  Â  Â  Â  const dateHeaderRow = document.createElement('tr');
Â  Â  Â  Â  dateHeaderRow.classList.add('group-header');
Â  Â  Â  Â  const dateObj = new Date(date + 'T00:00:00');
Â  Â  Â  Â  const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  dateHeaderRow.innerHTML = `<td colspan="6">ğŸ—“ï¸ **Date:** ${formattedDate}</td>`;
Â  Â  Â  Â  tableBody.appendChild(dateHeaderRow);

Â  Â  Â  Â  // Detail Rows
Â  Â  Â  Â  ordersByDate.forEach(order => {
Â  Â  Â  Â  Â  dailyTotal += order.targetDN;
Â  Â  Â  Â  Â  grandTotal += order.targetDN;

Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  <td>${order.date}</td>
Â  Â  Â  Â  Â  Â  <td><span class="badge badge-${order.type.toLowerCase().replace(' ', '')}">${order.type}</span></td>
Â  Â  Â  Â  Â  Â  <td>${order.customerName}</td>
Â  Â  Â  Â  Â  Â  <td>${order.destination}</td>
Â  Â  Â  Â  Â  Â  <td>**${order.targetDN.toFixed(2)}**</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" onclick="openEditModal('${order.id}')">âœï¸ Edit</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">ğŸ—‘ï¸ Delete</button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  tableBody.appendChild(row);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Daily Subtotal Row
Â  Â  Â  Â  const subtotalRow = document.createElement('tr');
Â  Â  Â  Â  subtotalRow.classList.add('subtotal-row');
Â  Â  Â  Â  subtotalRow.innerHTML = `
Â  Â  Â  Â  Â  <td colspan="4" style="text-align: right;">**Daily Total (${formattedDate}):**</td>
Â  Â  Â  Â  Â  <td>**${dailyTotal.toFixed(2)}**</td>
Â  Â  Â  Â  Â  <td></td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tableBody.appendChild(subtotalRow);
Â  Â  Â  }

Â  Â  Â  // Grand Total Row
Â  Â  Â  const grandTotalRow = document.createElement('tr');
Â  Â  Â  grandTotalRow.classList.add('subtotal-row');
Â  Â  Â  grandTotalRow.style.backgroundColor = '#FFB6C1';
Â  Â  Â  grandTotalRow.style.color = 'white';
Â  Â  Â  grandTotalRow.innerHTML = `
Â  Â  Â  Â  <td colspan="4" style="text-align: right;">**GRAND TOTAL (All Filtered Orders):**</td>
Â  Â  Â  Â  <td>**${grandTotal.toFixed(2)}**</td>
Â  Â  Â  Â  <td></td>
Â  Â  Â  `;
Â  Â  Â  tableBody.appendChild(grandTotalRow);


Â  Â  Â  renderStats(filteredOrders);
Â  Â  }

Â  Â  // Render the calendar view
Â  Â  function renderCalendar() {
Â  Â  Â  const calendarGrid = document.getElementById('calendarGrid');
Â  Â  Â  const calendarMonth = document.getElementById('calendarMonth');
Â  Â  Â  
Â  Â  Â  const year = currentDate.getFullYear();
Â  Â  Â  const month = currentDate.getMonth();

Â  Â  Â  calendarMonth.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

Â  Â  Â  // Get the first day of the month and the number of days in the month
Â  Â  Â  const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 (Sun) to 6 (Sat)
Â  Â  Â  const daysInMonth = new Date(year, month + 1, 0).getDate();
Â  Â  Â  const daysInPrevMonth = new Date(year, month, 0).getDate();

Â  Â  Â  // Collect order counts for the current month
Â  Â  Â  const orderCounts = orders.reduce((acc, order) => {
Â  Â  Â  Â  const orderDate = new Date(order.date + 'T00:00:00');
Â  Â  Â  Â  if (orderDate.getFullYear() === year && orderDate.getMonth() === month) {
Â  Â  Â  Â  Â  const dayKey = orderDate.getDate();
Â  Â  Â  Â  Â  acc[dayKey] = (acc[dayKey] || 0) + 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  return acc;
Â  Â  Â  }, {});

Â  Â  Â  // Today's date for comparison
Â  Â  Â  const today = new Date();
Â  Â  Â  today.setHours(0, 0, 0, 0);
Â  Â  Â  const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

Â  Â  Â  calendarGrid.innerHTML = '';

Â  Â  Â  // Weekday headers
Â  Â  Â  ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
Â  Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  Â  header.classList.add('calendar-day-header');
Â  Â  Â  Â  header.textContent = day;
Â  Â  Â  Â  calendarGrid.appendChild(header);
Â  Â  Â  });

Â  Â  Â  // Pre-padding days (Previous month)
Â  Â  Â  // The 'firstDayOfMonth' is 0 for Sunday, 1 for Monday, etc.
Â  Â  Â  // We want the week to start on Sunday.
Â  Â  Â  const startDayIndex = (firstDayOfMonth === 0) ? 7 : firstDayOfMonth;

Â  Â  Â  for (let i = startDayIndex; i > 1; i--) {
Â  Â  Â  Â  const day = document.createElement('div');
Â  Â  Â  Â  day.classList.add('calendar-day', 'other-month');
Â  Â  Â  Â  day.innerHTML = `<span class="calendar-day-number">${daysInPrevMonth - i + 2}</span>`;
Â  Â  Â  Â  calendarGrid.appendChild(day);
Â  Â  Â  }

Â  Â  Â  // Current month days
Â  Â  Â  for (let day = 1; day <= daysInMonth; day++) {
Â  Â  Â  Â  const dayEl = document.createElement('div');
Â  Â  Â  Â  dayEl.classList.add('calendar-day');

Â  Â  Â  Â  const currentDayOfWeek = new Date(year, month, day).getDay(); // 0 (Sun) to 6 (Sat)
Â  Â  Â  Â  if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
Â  Â  Â  Â  Â  dayEl.classList.add('weekend');
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isCurrentMonth && day === today.getDate()) {
Â  Â  Â  Â  Â  dayEl.classList.add('today');
Â  Â  Â  Â  }

Â  Â  Â  Â  const orderCount = orderCounts[day] || 0;
Â  Â  Â  Â  if (orderCount > 0) {
Â  Â  Â  Â  Â  dayEl.classList.add('has-orders');
Â  Â  Â  Â  Â  dayEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <span class="calendar-day-number">${day}</span>
Â  Â  Â  Â  Â  Â  <span class="calendar-day-count">${orderCount} Order(s)</span>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  dayEl.innerHTML = `<span class="calendar-day-number">${day}</span>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
Â  Â  Â  Â  dayEl.addEventListener('click', () => selectDate(dateStr, dayEl));

Â  Â  Â  Â  calendarGrid.appendChild(dayEl);
Â  Â  Â  }

Â  Â  Â  // Post-padding days (Next month) - to complete a 42-cell grid
Â  Â  Â  const totalCells = calendarGrid.children.length;
Â  Â  Â  const remainingCells = 42 - totalCells;
Â  Â  Â  
Â  Â  Â  for (let i = 1; i <= remainingCells; i++) {
Â  Â  Â  Â  const day = document.createElement('div');
Â  Â  Â  Â  day.classList.add('calendar-day', 'other-month');
Â  Â  Â  Â  day.innerHTML = `<span class="calendar-day-number">${i}</span>`;
Â  Â  Â  Â  calendarGrid.appendChild(day);
Â  Â  Â  }
Â  Â  }

Â  Â  // Handle date selection from the calendar
Â  Â  function selectDate(dateStr, dayEl) {
Â  Â  Â  // Remove selected class from all days
Â  Â  Â  document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
Â  Â  Â  
Â  Â  Â  // Apply selected class
Â  Â  Â  dayEl.classList.add('selected');

Â  Â  Â  // Update filters
Â  Â  Â  document.getElementById('filterDate').value = dateStr;
Â  Â  Â  document.getElementById('filterMonth').value = '';
Â  Â  Â  document.getElementById('searchInput').value = '';
Â  Â  Â  document.getElementById('filterType').value = '';

Â  Â  Â  // Re-render table
Â  Â  Â  renderTable();
Â  Â  Â  showToast(`Filtered orders for ${dateStr}`, 'info');
Â  Â  }

Â  Â  // Change month in calendar
Â  Â  function changeMonth(delta) {
Â  Â  Â  currentDate.setMonth(currentDate.getMonth() + delta);
Â  Â  Â  renderCalendar();
Â  Â  }

Â  Â  // Render all components
Â  Â  function renderAll() {
Â  Â  Â  populateFilters();
Â  Â  Â  renderCalendar();
Â  Â  Â  renderTable();
Â  Â  }

Â  Â  // --- Event Handlers & Business Logic ---

Â  Â  // Add new order
Â  Â  document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  
Â  Â  Â  const dateInput = document.getElementById('dateInput');
Â  Â  Â  const orderType = document.getElementById('orderType');
Â  Â  Â  const customerName = document.getElementById('customerName');
Â  Â  Â  const destination = document.getElementById('destination');
Â  Â  Â  const targetDN = document.getElementById('targetDN');

Â  Â  Â  // Apply rounding rule
Â  Â  Â  const roundedTargetDN = roundTargetDN(targetDN.value);

Â  Â  Â  const newOrder = {
Â  Â  Â  Â  id: generateId(),
Â  Â  Â  Â  date: dateInput.value,
Â  Â  Â  Â  type: orderType.value,
Â  Â  Â  Â  customerName: customerName.value,
Â  Â  Â  Â  destination: destination.value,
Â  Â  Â  Â  targetDN: roundedTargetDN,
Â  Â  Â  };

Â  Â  Â  orders.push(newOrder);
Â  Â  Â  await saveData();
Â  Â  Â  showToast(`Order for ${newOrder.customerName} added! Target DN: ${roundedTargetDN.toFixed(2)}`, 'success');

Â  Â  Â  // Clear form and re-render
Â  Â  Â  document.getElementById('addOrderForm').reset();
Â  Â  Â  // Set date input to today's date after reset
Â  Â  Â  dateInput.value = new Date().toISOString().split('T')[0];
Â  Â  Â  renderAll();
Â  Â  });

Â  Â  // Delete order
Â  Â  window.deleteOrder = async function(id) {
Â  Â  Â  if (confirm('Are you sure you want to delete this order?')) {
Â  Â  Â  Â  const initialLength = orders.length;
Â  Â  Â  Â  orders = orders.filter(order => order.id !== id);
Â  Â  Â  Â  if (orders.length < initialLength) {
Â  Â  Â  Â  Â  await saveData();
Â  Â  Â  Â  Â  showToast('Order deleted successfully!', 'error');
Â  Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };

Â  Â  // Open Edit Modal
Â  Â  window.openEditModal = function(id) {
Â  Â  Â  const order = orders.find(o => o.id === id);
Â  Â  Â  if (!order) return;

Â  Â  Â  currentEditingId = id;
Â  Â  Â  document.getElementById('editDate').value = order.date;
Â  Â  Â  document.getElementById('editOrderType').value = order.type;
Â  Â  Â  document.getElementById('editCustomerName').value = order.customerName;
Â  Â  Â  document.getElementById('editDestination').value = order.destination;
Â  Â  Â  document.getElementById('editTargetDN').value = order.targetDN;

Â  Â  Â  document.getElementById('editModal').classList.add('active');
Â  Â  };

Â  Â  // Close Edit Modal
Â  Â  window.closeEditModal = function() {
Â  Â  Â  document.getElementById('editModal').classList.remove('active');
Â  Â  Â  currentEditingId = null;
Â  Â  };

Â  Â  // Update order
Â  Â  document.getElementById('editOrderForm').addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  
Â  Â  Â  const index = orders.findIndex(o => o.id === currentEditingId);
Â  Â  Â  if (index === -1) {
Â  Â  Â  Â  showToast('Error: Order not found for update.', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const editedOrder = {
Â  Â  Â  Â  id: currentEditingId,
Â  Â  Â  Â  date: document.getElementById('editDate').value,
Â  Â  Â  Â  type: document.getElementById('editOrderType').value,
Â  Â  Â  Â  customerName: document.getElementById('editCustomerName').value,
Â  Â  Â  Â  destination: document.getElementById('editDestination').value,
Â  Â  Â  Â  targetDN: roundTargetDN(document.getElementById('editTargetDN').value),
Â  Â  Â  };

Â  Â  Â  orders[index] = editedOrder;
Â  Â  Â  await saveData();
Â  Â  Â  showToast(`Order for ${editedOrder.customerName} updated! Target DN: ${editedOrder.targetDN.toFixed(2)}`, 'success');
Â  Â  Â  
Â  Â  Â  closeEditModal();
Â  Â  Â  renderAll();
Â  Â  });

Â  Â  // Filter event listeners
Â  Â  document.getElementById('searchInput').addEventListener('input', renderTable);
Â  Â  document.getElementById('filterMonth').addEventListener('change', renderTable);
Â  Â  document.getElementById('filterDate').addEventListener('change', renderTable);
Â  Â  document.getElementById('filterType').addEventListener('change', renderTable);

Â  Â  // Calendar navigation event listeners
Â  Â  document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
Â  Â  document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));

Â  Â  // Download Dropdown Toggle
Â  Â  document.getElementById('downloadBtn').addEventListener('click', (e) => {
Â  Â  Â  document.getElementById('downloadDropdown').classList.toggle('active');
Â  Â  Â  e.stopPropagation();
Â  Â  });

Â  Â  // Close dropdown when clicking outside
Â  Â  document.addEventListener('click', () => {
Â  Â  Â  document.getElementById('downloadDropdown').classList.remove('active');
Â  Â  });

Â  Â  // Handle Download Options
Â  Â  document.querySelectorAll('.download-option').forEach(option => {
Â  Â  Â  option.addEventListener('click', (e) => {
Â  Â  Â  Â  const format = e.currentTarget.dataset.format;
Â  Â  Â  Â  downloadData(format);
Â  Â  Â  Â  document.getElementById('downloadDropdown').classList.remove('active');
Â  Â  Â  });
Â  Â  });

Â  Â  // Download function
Â  Â  function downloadData(format) {
Â  Â  Â  const dataToDownload = filterData();
Â  Â  Â  if (dataToDownload.length === 0) {
Â  Â  Â  Â  showToast('No data to download based on current filters.', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (format === 'excel') {
Â  Â  Â  Â  // Convert to CSV format
Â  Â  Â  Â  const headers = ["ID", "Date", "Type", "Customer Name", "Destination", "Target DN (MT)"];
Â  Â  Â  Â  const csv = [
Â  Â  Â  Â  Â  headers.join(','),
Â  Â  Â  Â  Â  ...dataToDownload.map(d => [d.id, d.date, d.type, `"${d.customerName.replace(/"/g, '""')}"`, `"${d.destination.replace(/"/g, '""')}"`, d.targetDN.toFixed(2)].join(','))
Â  Â  Â  Â  ].join('\n');

Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  link.setAttribute("href", url);
Â  Â  Â  Â  link.setAttribute("download", "dn_orders_data.csv");
Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  link.click();
Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  showToast('Data downloaded as CSV!', 'success');

Â  Â  Â  } else if (format === 'pdf') {
Â  Â  Â  Â  // Use the print preview for PDF generation
Â  Â  Â  Â  preparePrintPreview();
Â  Â  Â  Â  window.print();
Â  Â  Â  Â  // showToast('Please use your browser\'s Print to PDF option.', 'info');
Â  Â  Â  }
Â  Â  }

Â  Â  // Print Preview Logic
Â  Â  document.getElementById('printBtn').addEventListener('click', () => {
Â  Â  Â  preparePrintPreview();
Â  Â  Â  document.getElementById('printModal').classList.add('active');
Â  Â  });

Â  Â  window.closePrintModal = function() {
Â  Â  Â  document.getElementById('printModal').classList.remove('active');
Â  Â  };

Â  Â  function preparePrintPreview() {
Â  Â  Â  const printPreview = document.getElementById('printPreview');
Â  Â  Â  const filteredOrders = filterData();
Â  Â  Â  const stats = calculateStats(filteredOrders);
Â  Â  Â  
Â  Â  Â  const dateGenerated = new Date().toLocaleString();

Â  Â  Â  // Group by Date for Print View
Â  Â  Â  const groupedOrders = filteredOrders.sort((a, b) => new Date(a.date) - new Date(b.date)).reduce((acc, order) => {
Â  Â  Â  Â  (acc[order.date] = acc[order.date] || []).push(order);
Â  Â  Â  Â  return acc;
Â  Â  Â  }, {});

Â  Â  Â  let tableRows = '';
Â  Â  Â  let grandTotal = 0;

Â  Â  Â  for (const date in groupedOrders) {
Â  Â  Â  Â  const ordersByDate = groupedOrders[date];
Â  Â  Â  Â  let dailyTotal = 0;

Â  Â  Â  Â  const dateObj = new Date(date + 'T00:00:00');
Â  Â  Â  Â  const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

Â  Â  Â  Â  tableRows += `<tr class="group-header"><td colspan="5">ğŸ—“ï¸ **Date:** ${formattedDate}</td></tr>`;

Â  Â  Â  Â  ordersByDate.forEach(order => {
Â  Â  Â  Â  Â  dailyTotal += order.targetDN;
Â  Â  Â  Â  Â  grandTotal += order.targetDN;
Â  Â  Â  Â  Â  tableRows += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <td>${order.type}</td>
Â  Â  Â  Â  Â  Â  Â  <td>${order.customerName}</td>
Â  Â  Â  Â  Â  Â  Â  <td>${order.destination}</td>
Â  Â  Â  Â  Â  Â  Â  <td style="text-align: right;">${order.targetDN.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });

Â  Â  Â  Â  tableRows += `
Â  Â  Â  Â  Â  <tr class="subtotal-row">
Â  Â  Â  Â  Â  Â  <td colspan="3" style="text-align: right;">**Daily Total:**</td>
Â  Â  Â  Â  Â  Â  <td style="text-align: right;">**${dailyTotal.toFixed(2)}**</td>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  Â  }

Â  Â  Â  if (filteredOrders.length === 0) {
Â  Â  Â  Â  tableRows = `<tr><td colspan="5" style="text-align: center;">No data found for the current filters.</td></tr>`;
Â  Â  Â  }

Â  Â  Â  const content = `
Â  Â  Â  Â  <div class="print-header">
Â  Â  Â  Â  Â  <div class="print-logo">DN Order Report</div>
Â  Â  Â  Â  Â  <div class="print-subtitle">Target Vs Realization Create DN Local Order</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="print-meta">
Â  Â  Â  Â  Â  <div>**Report Date:** ${dateGenerated}</div>
Â  Â  Â  Â  Â  <div>**Filtered Orders:** ${filteredOrders.length}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="print-stats">
Â  Â  Â  Â  Â  <div class="print-stat-box" style="background-color: #FFE5E9;">
Â  Â  Â  Â  Â  Â  <div class="print-stat-label">Total Target BU 17</div>
Â  Â  Â  Â  Â  Â  <div class="print-stat-value">${stats.totalBU17} MT</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="print-stat-box" style="background-color: #E5F8F0;">
Â  Â  Â  Â  Â  Â  <div class="print-stat-label">Total Target CMI</div>
Â  Â  Â  Â  Â  Â  <div class="print-stat-value">${stats.totalCMI} MT</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="print-stat-box" style="background-color: #FFD4A3;">
Â  Â  Â  Â  Â  Â  <div class="print-stat-label">Total All Target</div>
Â  Â  Â  Â  Â  Â  <div class="print-stat-value">${stats.totalAll} MT</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="table-wrapper">
Â  Â  Â  Â  Â  <table class="data-table" style="width: 100%;">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%;">Type</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 30%;">Customer Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 30%;">Destination</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 30%; text-align: right;">Target DN (MT)</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  ${tableRows}
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  
Â  Â  Â  printPreview.innerHTML = content;
Â  Â  Â  
Â  Â  Â  // Ensure print styles are applied to the generated content for better PDF output
Â  Â  Â  const printTable = printPreview.querySelector('.data-table');
Â  Â  Â  if (printTable) {
Â  Â  Â  Â  printTable.querySelectorAll('th').forEach(th => th.style.padding = '10px');
Â  Â  Â  Â  printTable.querySelectorAll('td').forEach(td => {
Â  Â  Â  Â  Â  td.style.padding = '8px';
Â  Â  Â  Â  Â  td.style.borderBottom = '1px solid #ddd';
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  // Initialize
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  // Set initial date input to today
Â  Â  Â  document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
Â  Â  Â  loadData();
Â  Â  });
Â  Â  
Â  Â  // Expose changeTheme globally for inline HTML onclick (non-ideal but necessary for the structure)
Â  Â  window.changeTheme = changeTheme;
Â  </script>
Â </body>
</html>
