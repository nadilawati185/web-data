document.addEventListener('DOMContentLoaded', () => {
    // --- Global State ---
    let orders = [];
    let currentMonth = new Date();
    let selectedDate = new Date();
    let isEditing = false;
    let currentEditIndex = -1;
    let currentTheme = 'pink';
    let dailyTargetChartInstance = null; // Chart.js instance

    const themes = {
        pink: {
            background_color: '#FFB6C1',
            primary_action_color: '#FF8FA3',
            secondary_action_color: '#A8E6CF',
            chart_bu17: 'rgba(255, 143, 163, 0.8)',
            chart_cmi: 'rgba(168, 230, 207, 0.8)'
        },
        mint: {
            background_color: '#A8E6CF',
            primary_action_color: '#7ED9B3',
            secondary_action_color: '#FFB6C1',
            chart_bu17: 'rgba(255, 182, 193, 0.8)',
            chart_cmi: 'rgba(126, 217, 179, 0.8)'
        },
        lavender: {
            background_color: '#D4A5D4',
            primary_action_color: '#B794C8',
            secondary_action_color: '#A8E6CF',
            chart_bu17: 'rgba(183, 148, 200, 0.8)',
            chart_cmi: 'rgba(168, 230, 207, 0.8)'
        },
        peach: {
            background_color: '#FFD4A3',
            primary_action_color: '#FFBC7D',
            secondary_action_color: '#B4D7FF',
            chart_bu17: 'rgba(255, 188, 125, 0.8)',
            chart_cmi: 'rgba(180, 215, 255, 0.8)'
        },
        sky: {
            background_color: '#B4D7FF',
            primary_action_color: '#8FC1FF',
            secondary_action_color: '#FFB6C1',
            chart_bu17: 'rgba(143, 193, 255, 0.8)',
            chart_cmi: 'rgba(255, 182, 193, 0.8)'
        },
        lemon: {
            background_color: '#FFF9A3',
            primary_action_color: '#FFE97D',
            secondary_action_color: '#A8E6CF',
            chart_bu17: 'rgba(255, 233, 125, 0.8)',
            chart_cmi: 'rgba(168, 230, 207, 0.8)'
        }
    };

    // --- DOM Elements ---
    const tableBody = document.getElementById('tableBody');
    const emptyState = document.getElementById('emptyState');
    const loadingElement = document.getElementById('loading');
    const addOrderForm = document.getElementById('addOrderForm');
    const editOrderForm = document.getElementById('editOrderForm');
    const editModal = document.getElementById('editModal');
    const printModal = document.getElementById('printModal');
    const printPreview = document.getElementById('printPreview');
    const totalBU17El = document.getElementById('totalBU17');
    const totalCMIEI = document.getElementById('totalCMI');
    const totalAllEl = document.getElementById('totalAll');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarMonthEl = document.getElementById('calendarMonth');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const searchInput = document.getElementById('searchInput');
    const filterMonth = document.getElementById('filterMonth');
    const filterDate = document.getElementById('filterDate');
    const filterType = document.getElementById('filterType');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadDropdown = document.getElementById('downloadDropdown');
    const downloadOptions = document.querySelectorAll('.download-option');
    const printBtn = document.getElementById('printBtn');
    const toast = document.getElementById('toast');

    // --- Utility Functions ---

    /**
     * Converts a Date object to a 'YYYY-MM-DD' string.
     */
    const formatDate = (date) => {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    };

    /**
     * Helper to convert hex to RGB for boxShadow opacity.
     */
    const hexToRgb = (hex) => {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `${r}, ${g}, ${b}`;
    };

    /**
     * Shows a toast notification.
     */
    const showToast = (message, type = 'success') => {
        toast.textContent = message;
        toast.className = `toast active ${type}`;
        setTimeout(() => {
            toast.classList.remove('active');
        }, 3000);
    };

    // --- Data Operations (CRUD) ---

    /**
     * Loads orders from data_sdk (simulating backend/local storage).
     */
    const loadOrders = async () => {
        loadingElement.classList.add('active');
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            orders = await Data.get('dn_orders') || [];
        } catch (error) {
            console.error('Error loading orders:', error);
            showToast('Failed to load orders.', 'error');
        } finally {
            loadingElement.classList.remove('active');
            // Re-render all components after load
            renderOrders();
            updateStats();
            generateCalendar(currentMonth);
            populateFilters();
            renderDailyTargetChart();
            changeTheme(currentTheme); // Apply initial theme
        }
    };

    /**
     * Saves orders to data_sdk and updates all relevant UI components.
     */
    const saveOrders = async () => {
        try {
            await Data.set('dn_orders', orders);
            updateStats();
            generateCalendar(currentMonth);
            populateFilters();
            renderDailyTargetChart(); // Update chart on data change
        } catch (error) {
            console.error('Error saving orders:', error);
            showToast('Failed to save orders.', 'error');
        }
    };

    /**
     * Adds a new order.
     */
    const addOrder = (e) => {
        e.preventDefault();
        const newOrder = {
            id: Date.now(),
            date: document.getElementById('dateInput').value,
            type: document.getElementById('orderType').value,
            customer: document.getElementById('customerName').value.trim(),
            destination: document.getElementById('destination').value.trim(),
            target: parseFloat(document.getElementById('targetDN').value),
        };

        if (newOrder.date && newOrder.type && newOrder.customer && newOrder.destination && !isNaN(newOrder.target)) {
            orders.push(newOrder);
            saveOrders();
            renderOrders();
            addOrderForm.reset();
            showToast('Order added successfully!');
        } else {
            showToast('Please fill all fields correctly.', 'error');
        }
    };

    /**
     * Opens the edit modal and pre-fills data.
     */
    window.openEditModal = (id) => {
        const index = orders.findIndex(order => order.id === id);
        if (index === -1) return showToast('Order not found!', 'error');

        isEditing = true;
        currentEditIndex = index;
        const order = orders[index];

        document.getElementById('editDate').value = order.date;
        document.getElementById('editOrderType').value = order.type;
        document.getElementById('editCustomerName').value = order.customer;
        document.getElementById('editDestination').value = order.destination;
        document.getElementById('editTargetDN').value = order.target.toFixed(2);

        editModal.classList.add('active');
    };

    /**
     * Closes the edit modal.
     */
    window.closeEditModal = () => {
        isEditing = false;
        currentEditIndex = -1;
        editModal.classList.remove('active');
    };

    /**
     * Updates an existing order.
     */
    const updateOrder = (e) => {
        e.preventDefault();
        if (currentEditIndex === -1) return;

        const updatedOrder = {
            id: orders[currentEditIndex].id,
            date: document.getElementById('editDate').value,
            type: document.getElementById('editOrderType').value,
            customer: document.getElementById('editCustomerName').value.trim(),
            destination: document.getElementById('editDestination').value.trim(),
            target: parseFloat(document.getElementById('editTargetDN').value),
        };

        if (updatedOrder.date && updatedOrder.type && updatedOrder.customer && updatedOrder.destination && !isNaN(updatedOrder.target)) {
            orders[currentEditIndex] = updatedOrder;
            saveOrders();
            renderOrders();
            closeEditModal();
            showToast('Order updated successfully!');
        } else {
            showToast('Please fill all fields correctly.', 'error');
        }
    };

    /**
     * Deletes an order.
     */
    window.deleteOrder = (id) => {
        if (confirm('Are you sure you want to delete this order?')) {
            const initialLength = orders.length;
            orders = orders.filter(order => order.id !== id);
            if (orders.length < initialLength) {
                saveOrders();
                renderOrders();
                showToast('Order deleted successfully!');
            } else {
                showToast('Order not found.', 'error');
            }
        }
    };

    // --- Filtering & Rendering ---

    /**
     * Applies current filters to the orders array.
     */
    const getFilteredOrders = () => {
        const searchText = searchInput.value.toLowerCase();
        const monthFilter = filterMonth.value;
        const dateFilter = filterDate.value;
        const typeFilter = filterType.value;

        return orders.filter(order => {
            const orderDate = new Date(order.date);
            const orderMonthYear = `${orderDate.getFullYear()}-${orderDate.getMonth()}`;
            const orderDay = orderDate.getDate().toString();

            const matchesSearch = searchText === '' ||
                order.customer.toLowerCase().includes(searchText) ||
                order.destination.toLowerCase().includes(searchText) ||
                order.type.toLowerCase().includes(searchText);

            const matchesMonth = monthFilter === '' || orderMonthYear === monthFilter;
            const matchesDate = dateFilter === '' || orderDay === dateFilter;
            const matchesType = typeFilter === '' || order.type === typeFilter;

            return matchesSearch && matchesMonth && matchesDate && matchesType;
        });
    };

    /**
     * Renders the orders table with grouping and totals.
     */
    const renderOrders = () => {
        const filteredOrders = getFilteredOrders();
        tableBody.innerHTML = '';

        if (filteredOrders.length === 0) {
            emptyState.style.display = 'block';
            renderDailyTargetChart(); 
            return;
        }

        emptyState.style.display = 'none';

        // Grouping logic: Group by Type, then by Date
        const groupedByType = filteredOrders.reduce((acc, order) => {
            acc[order.type] = acc[order.type] || [];
            acc[order.type].push(order);
            return acc;
        }, {});

        let grandTotal = 0;

        for (const type in groupedByType) {
            // Type Header Row
            const typeHeader = tableBody.insertRow();
            typeHeader.className = 'group-header';
            typeHeader.innerHTML = `<td colspan="6">Order Type: <span class="badge badge-${type.toLowerCase().replace(' ', '')}">${type}</span></td>`;

            const ordersByType = groupedByType[type];
            let typeSubtotal = 0;

            // Group by Date within Type
            const groupedByDate = ordersByType.reduce((acc, order) => {
                acc[order.date] = acc[order.date] || [];
                acc[order.date].push(order);
                return acc;
            }, {});

            for (const date in groupedByDate) {
                let dateSubtotal = 0;

                // Date Subtotal Row (as a group header for date)
                const dateHeader = tableBody.insertRow();
                dateHeader.className = 'subtotal-row';
                dateHeader.innerHTML = `<td colspan="6" style="padding-left: 20px; font-style: italic; background: #EBF8FF;">Date: ${date}</td>`;

                groupedByDate[date].forEach(order => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${order.date}</td>
                        <td><span class="badge badge-${order.type.toLowerCase().replace(' ', '')}">${order.type}</span></td>
                        <td>${order.customer}</td>
                        <td>${order.destination}</td>
                        <td>${order.target.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-edit" onclick="openEditModal(${order.id})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="deleteOrder(${order.id})">üóëÔ∏è Delete</button>
                        </td>
                    `;
                    dateSubtotal += order.target;
                });

                // Display Date Subtotal
                const dateSubtotalRow = tableBody.insertRow();
                dateSubtotalRow.className = 'subtotal-row';
                dateSubtotalRow.innerHTML = `
                    <td colspan="4" style="text-align: right; padding-right: 12px; font-style: italic;">Subtotal Target for ${date}:</td>
                    <td><strong>${dateSubtotal.toFixed(2)}</strong></td>
                    <td></td>
                `;

                typeSubtotal += dateSubtotal;
            }

            // Display Type Subtotal
            const typeSubtotalRow = tableBody.insertRow();
            typeSubtotalRow.className = 'subtotal-row';
            typeSubtotalRow.style.background = '#FFECF2';
            typeSubtotalRow.innerHTML = `
                <td colspan="4" style="text-align: right; padding-right: 12px;">Total Target for ${type}:</td>
                <td><strong>${typeSubtotal.toFixed(2)}</strong></td>
                <td></td>
            `;

            grandTotal += typeSubtotal;
        }

        // Display Grand Total
        const grandTotalRow = tableBody.insertRow();
        grandTotalRow.className = 'group-header';
        grandTotalRow.style.fontSize = '1.1em';
        grandTotalRow.style.background = 'linear-gradient(135deg, #FFD4A3 0%, #FFBC7D 100%)';
        grandTotalRow.innerHTML = `
            <td colspan="4" style="text-align: right; padding-right: 12px; color: #2D3748;">GRAND TOTAL TARGET:</td>
            <td style="color: #2D3748;"><strong>${grandTotal.toFixed(2)}</strong></td>
            <td></td>
        `;
        
        renderDailyTargetChart(); // Render chart after table
    };

    /**
     * Populates the month and date filter dropdowns dynamically.
     */
    const populateFilters = () => {
        // Month Filter
        const months = [...new Set(orders.map(order => {
            const date = new Date(order.date);
            return `${date.getFullYear()}-${date.getMonth()}`;
        }))].sort();

        filterMonth.innerHTML = '<option value="">All Months</option>';
        months.forEach(monthKey => {
            const [year, monthIndex] = monthKey.split('-').map(Number);
            const date = new Date(year, monthIndex, 1);
            const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
            const option = document.createElement('option');
            option.value = monthKey;
            option.textContent = monthName;
            filterMonth.appendChild(option);
        });

        // Date Filter (populates based on current month/data)
        const dates = [...new Set(orders.map(order => new Date(order.date).getDate().toString()))].sort((a, b) => parseInt(a) - parseInt(b));

        filterDate.innerHTML = '<option value="">All Dates</option>';
        dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = `Day ${date}`;
            filterDate.appendChild(option);
        });
    };

    // --- Statistics ---

    /**
     * Updates the summary statistics cards.
     */
    const updateStats = () => {
        const bu17Total = orders
            .filter(order => order.type === 'BU 17')
            .reduce((sum, order) => sum + order.target, 0);

        const cmiTotal = orders
            .filter(order => order.type === 'CMI')
            .reduce((sum, order) => sum + order.target, 0);

        const totalAll = bu17Total + cmiTotal;

        totalBU17El.textContent = bu17Total.toFixed(2);
        totalCMIEI.textContent = cmiTotal.toFixed(2);
        totalAllEl.textContent = totalAll.toFixed(2);
    };
    
    // --- Charting ---

    /**
     * Renders a bar chart comparing daily targets by order type.
     */
    const renderDailyTargetChart = () => {
        const filteredOrders = getFilteredOrders();
        const theme = themes[currentTheme];

        // 1. Group data by date and type
        const dataByDateAndType = filteredOrders.reduce((acc, order) => {
            acc[order.date] = acc[order.date] || { 'BU 17': 0, 'CMI': 0 };
            acc[order.date][order.type] += order.target;
            return acc;
        }, {});

        // 2. Prepare Chart Data
        const dates = Object.keys(dataByDateAndType).sort();
        const bu17Targets = dates.map(date => dataByDateAndType[date]['BU 17']);
        const cmiTargets = dates.map(date => dataByDateAndType[date]['CMI']);
        
        // 3. Destroy old instance if exists
        if (dailyTargetChartInstance) {
            dailyTargetChartInstance.destroy();
        }

        // 4. Get context and Render Chart
        const ctx = document.getElementById('dailyTargetChart').getContext('2d');
        
        dailyTargetChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates, // Dates on the X-axis
                datasets: [
                    {
                        label: 'Target BU 17 (MT)',
                        data: bu17Targets,
                        backgroundColor: theme.chart_bu17, 
                        borderColor: theme.primary_action_color,
                        borderWidth: 1
                    },
                    {
                        label: 'Target CMI (MT)',
                        data: cmiTargets,
                        backgroundColor: theme.chart_cmi, 
                        borderColor: theme.secondary_action_color,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: false, 
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        stacked: false, 
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Target DN (MT)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                    }
                }
            }
        });
    };

    // --- Calendar Functions ---

    /**
     * Gets orders grouped by date for the calendar view.
     */
    const getOrdersByDateInMonth = (date) => {
        const month = date.getMonth();
        const year = date.getFullYear();

        return orders.reduce((acc, order) => {
            const orderDate = new Date(order.date);
            if (orderDate.getMonth() === month && orderDate.getFullYear() === year) {
                const dateKey = formatDate(orderDate);
                acc[dateKey] = (acc[dateKey] || 0) + 1;
            }
            return acc;
        }, {});
    };

    /**
     * Generates and renders the calendar grid.
     */
    const generateCalendar = (date) => {
        calendarGrid.innerHTML = '';
        const year = date.getFullYear();
        const month = date.getMonth();
        const today = formatDate(new Date());
        const ordersByDate = getOrdersByDateInMonth(date);

        calendarMonthEl.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

        // Day Headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });

        // Calculate start and end days
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const startDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 6 for Saturday
        const totalDays = lastDayOfMonth.getDate();

        // Previous Month's filler days
        const prevMonth = new Date(year, month, 0);
        const daysInPrevMonth = prevMonth.getDate();

        for (let i = 0; i < startDayOfWeek; i++) {
            const day = document.createElement('div');
            day.className = 'calendar-day other-month';
            day.innerHTML = `<span class="calendar-day-number">${daysInPrevMonth - startDayOfWeek + i + 1}</span>`;
            calendarGrid.appendChild(day);
        }

        // Current Month's days
        for (let dayNum = 1; dayNum <= totalDays; dayNum++) {
            const dateStr = formatDate(new Date(year, month, dayNum));
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.dataset.date = dateStr;
            dayEl.onclick = () => selectDate(dateStr);

            const isWeekend = new Date(year, month, dayNum).getDay() % 6 === 0;

            if (isWeekend) dayEl.classList.add('weekend');
            if (dateStr === today) dayEl.classList.add('today');
            if (formatDate(selectedDate) === dateStr) dayEl.classList.add('selected');

            if (ordersByDate[dateStr]) {
                dayEl.classList.add('has-orders');
                dayEl.innerHTML = `
                    <span class="calendar-day-number">${dayNum}</span>
                    <span class="calendar-day-count">${ordersByDate[dateStr]} Orders</span>
                `;
            } else {
                dayEl.innerHTML = `<span class="calendar-day-number">${dayNum}</span>`;
            }
            calendarGrid.appendChild(dayEl);
        }

        // Next Month's filler days
        const totalCells = startDayOfWeek + totalDays;
        const remainingCells = 42 - totalCells; 

        for (let i = 1; i <= remainingCells; i++) {
            const day = document.createElement('div');
            day.className = 'calendar-day other-month';
            day.innerHTML = `<span class="calendar-day-number">${i}</span>`;
            calendarGrid.appendChild(day);
        }
    };

    /**
     * Navigates the calendar to the previous month.
     */
    const prevMonth = () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        generateCalendar(currentMonth);
    };

    /**
     * Navigates the calendar to the next month.
     */
    const nextMonth = () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        generateCalendar(currentMonth);
    };

    /**
     * Selects a date in the calendar and sets the filter.
     */
    const selectDate = (dateStr) => {
        selectedDate = new Date(dateStr);
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth();
        const day = selectedDate.getDate().toString();

        const monthKey = `${year}-${month}`;
        filterMonth.value = monthKey;
        filterDate.value = day;

        renderOrders();
        generateCalendar(currentMonth); 
    };

    // --- Theme Switching ---

    /**
     * Changes the dashboard's color theme.
     */
    window.changeTheme = (themeName) => {
        const theme = themes[themeName];
        if (!theme) return;
        currentTheme = themeName;

        const style = document.createElement('style');
        style.type = 'text/css';
        style.innerHTML = `
            .dashboard-container { background: linear-gradient(135deg, ${theme.background_color} 0%, #E5F3FF 100%) !important; }
            .calendar-nav-btn, .calendar-day.today, .data-table thead, .data-table thead th, .btn-primary { 
                background: linear-gradient(135deg, ${theme.background_color} 0%, ${theme.primary_action_color} 100%) !important;
                border-color: ${theme.primary_action_color} !important;
            }
            .calendar-day.today { box-shadow: 0 4px 12px rgba(${hexToRgb(theme.background_color)}, 0.5) !important; }
            .stat-card.bu17 { border-left-color: ${theme.primary_action_color} !important; }
            .stat-card.cmi { border-left-color: ${theme.secondary_action_color} !important; }
            .form-input:focus, .form-select:focus { border-color: ${theme.background_color} !important; box-shadow: 0 0 0 3px rgba(${hexToRgb(theme.background_color)}, 0.2) !important; }
        `;
        document.head.appendChild(style);

        document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('active'));
        document.querySelector(`.theme-card[data-theme="${themeName}"]`).classList.add('active');
        
        // Update chart colors instantly
        if (dailyTargetChartInstance) {
            dailyTargetChartInstance.data.datasets[0].backgroundColor = theme.chart_bu17;
            dailyTargetChartInstance.data.datasets[0].borderColor = theme.primary_action_color;
            dailyTargetChartInstance.data.datasets[1].backgroundColor = theme.chart_cmi;
            dailyTargetChartInstance.data.datasets[1].borderColor = theme.secondary_action_color;
            dailyTargetChartInstance.update();
        }
    };

    // --- Export and Print ---

    /**
     * Toggles the download dropdown visibility.
     */
    const toggleDownloadDropdown = () => {
        downloadDropdown.classList.toggle('active');
    };

    /**
     * Hides the download dropdown.
     */
    const hideDownloadDropdown = () => {
        downloadDropdown.classList.remove('active');
    };

    /**
     * Handles the download request (Excel, PDF, Image).
     */
    const handleDownload = (format) => {
        const allFilteredOrders = getFilteredOrders();
        if (allFilteredOrders.length === 0) {
            return showToast('No data to download.', 'error');
        }

        switch (format) {
            case 'excel':
                exportToExcel(allFilteredOrders);
                break;
            case 'pdf':
                // Note: PDF relies on both jspdf and html2canvas being correctly loaded
                exportToPDF('data-table-section'); 
                break;
            case 'image':
                exportToImage('data-table-section');
                break;
            default:
                showToast('Unsupported download format.', 'error');
        }
        hideDownloadDropdown();
    };

    /**
     * Exports data to an Excel (.xlsx) file.
     */
    const exportToExcel = (data) => {
        const worksheetData = data.map(order => ({
            Date: order.date,
            Type: order.type,
            'Customer Name': order.customer,
            Destination: order.destination,
            'Target DN (MT)': order.target.toFixed(2),
        }));

        const worksheet = XLSX.utils.json_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'DN_Orders');
        XLSX.writeFile(workbook, 'DN_Orders_Data.xlsx');
        showToast('Data exported to Excel successfully!');
    };

    /**
     * Generates HTML content for the print preview modal.
     */
    const generatePrintContent = () => {
        const filteredOrders = getFilteredOrders();
        const theme = themes[currentTheme];
        const stats = {
            bu17: filteredOrders.filter(o => o.type === 'BU 17').reduce((sum, o) => sum + o.target, 0).toFixed(2),
            cmi: filteredOrders.filter(o => o.type === 'CMI').reduce((sum, o) => sum + o.target, 0).toFixed(2),
            total: filteredOrders.reduce((sum, o) => sum + o.target, 0).toFixed(2),
        };

        let tableContent = `<table class="data-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: ${theme.primary_action_color}; color: white;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Date</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Type</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Customer Name</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Destination</th>
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Target DN (MT)</th>
                </tr>
            </thead>
            <tbody>`;

        if (filteredOrders.length === 0) {
            tableContent += `<tr><td colspan="5" style="text-align: center; padding: 20px;">No orders found for the current filters.</td></tr>`;
        } else {
            const grouped = filteredOrders.reduce((acc, order) => {
                const key = order.type;
                acc[key] = acc[key] || [];
                acc[key].push(order);
                return acc;
            }, {});

            for (const type in grouped) {
                let typeTotal = 0;
                tableContent += `<tr style="background: #FFECF2; font-weight: bold;"><td colspan="5" style="padding: 8px; border: 1px solid #ddd;">Order Type: ${type}</td></tr>`;
                grouped[type].forEach(order => {
                    tableContent += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${order.date}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${order.type}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${order.customer}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${order.destination}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${order.target.toFixed(2)}</td>
                        </tr>
                    `;
                    typeTotal += order.target;
                });
                tableContent += `<tr style="background: #F7FAFC; font-weight: bold;"><td colspan="4" style="text-align: right; padding: 8px; border: 1px solid #ddd;">Total ${type}:</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${typeTotal.toFixed(2)}</td></tr>`;
            }
        }
        
        tableContent += '</tbody></table>';

        printPreview.innerHTML = `
            <div class="print-header">
                <div class="print-logo">DN Order Tracking Report</div>
                <div class="print-subtitle">Filtered Data: ${new Date().toLocaleString()}</div>
            </div>
            <div class="print-stats">
                <div class="print-stat-box">
                    <div class="print-stat-label">Total Target BU 17</div>
                    <div class="print-stat-value" style="color: ${theme.primary_action_color};">${stats.bu17} MT</div>
                </div>
                <div class="print-stat-box">
                    <div class="print-stat-label">Total Target CMI</div>
                    <div class="print-stat-value" style="color: ${theme.secondary_action_color};">${stats.cmi} MT</div>
                </div>
                <div class="print-stat-box">
                    <div class="print-stat-label">Grand Total Target</div>
                    <div class="print-stat-value">${stats.total} MT</div>
                </div>
            </div>
            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 18px; font-weight: 700; color: #2D3748;">Order Details:</h3>
            ${tableContent}
        `;
        printModal.classList.add('active');
    };

    /**
     * Closes the print preview modal.
     */
    window.closePrintModal = () => {
        printModal.classList.remove('active');
    };

    /**
     * Exports an element to a PDF file using jspdf and html2canvas.
     */
    const exportToPDF = (elementId) => {
        const input = document.getElementById(elementId).closest('.data-table-section');
        const { jsPDF } = window.jspdf;
        // Check if html2canvas is available (assuming correct CDN link)
        if (typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
             return showToast('Export Failed: Missing PDF/Image library (html2canvas/jspdf).', 'error');
        }
        
        html2canvas(input, { scale: 2 }).then((canvas) => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('DN_Orders_Table.pdf');
            showToast('Table exported to PDF successfully!');
        }).catch(error => {
            console.error('PDF export failed:', error);
            showToast('PDF export failed. Check console for details.', 'error');
        });
    };

    /**
     * Exports an element to a PNG image using html2canvas.
     */
    const exportToImage = (elementId) => {
        const input = document.getElementById(elementId).closest('.data-table-section');
        
        // Check if html2canvas is available (assuming correct CDN link)
        if (typeof html2canvas === 'undefined') {
             return showToast('Export Failed: Missing Image library (html2canvas).', 'error');
        }

        html2canvas(input, { scale: 2 }).then((canvas) => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'DN_Orders_Table.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Table exported to PNG image successfully!');
        }).catch(error => {
            console.error('Image export failed:', error);
            showToast('Image export failed. Check console for details.', 'error');
        });
    };

    // --- Event Listeners ---
    addOrderForm.addEventListener('submit', addOrder);
    editOrderForm.addEventListener('submit', updateOrder);
    prevMonthBtn.addEventListener('click', prevMonth);
    nextMonthBtn.addEventListener('click', nextMonth);
    searchInput.addEventListener('input', renderOrders);
    filterMonth.addEventListener('change', renderOrders);
    filterDate.addEventListener('change', renderOrders);
    filterType.addEventListener('change', renderOrders);
    downloadBtn.addEventListener('click', toggleDownloadDropdown);
    document.addEventListener('click', (e) => {
        if (!downloadBtn.contains(e.target) && !downloadDropdown.contains(e.target)) {
            hideDownloadDropdown();
        }
    });
    downloadOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            const format = e.target.dataset.format;
            handleDownload(format);
        });
    });
    printBtn.addEventListener('click', generatePrintContent);

    // --- Initialization ---
    loadOrders();
    // Set initial date input to today
    document.getElementById('dateInput').value = formatDate(new Date());
});